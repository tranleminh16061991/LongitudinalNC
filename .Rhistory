# Table 1
tab1 <- CreateTableOne(vars=vars_table1, strata=group_var, data=df_baseline)
print(tab1, showAllLevels=TRUE, quote=TRUE, noSpaces=TRUE)
# Table 1 group stats
get_pvals_es <- function(varlist, groupvar, df){
res <- lapply(varlist, function(v){
vals <- df[[v]]; g <- df[[groupvar]]
non_missing <- !(is.na(vals) | is.na(g))
vals_nm <- vals[non_missing]; g_nm <- g[non_missing]
pval <- NA; effsize <- NA
if(length(unique(g_nm)) != 2) return(list(pval=NA,effsize=NA))
if(is.numeric(vals_nm) | is.integer(vals_nm)){
p_norm <- tryCatch(shapiro.test(vals_nm)$p.value,error=function(e) NA)
if(!is.na(p_norm) && p_norm > 0.05){
ttest <- t.test(vals_nm ~ g_nm)
pval <- ttest$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm)$estimate
}else{
wilcox <- wilcox.test(vals_nm ~ g_nm)
pval <- wilcox$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm, hedges.correction=TRUE)$estimate
}
}else{
tbl <- table(vals_nm, g_nm)
pval <- if(any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
effsize <- NA
}
return(list(pval=pval,effsize=effsize))
})
names(res) <- varlist
return(res)
}
result_table1 <- get_pvals_es(vars_table1, group_var, df_baseline)
print(result_table1)
# Robust ANCOVA extraction: Each model gets its own contrast name dynamically and handles missing
extract_ancova <- function(model, group_var) {
# Find the actual contrast name (search for the one containing group_var and the comparison level)
ct_names <- grep(paste0(group_var), rownames(coef(model)), value=TRUE)
if(length(ct_names) > 0) {
# Use the one not equal to reference
est <- coef(model)[ct_names[1], "Estimate"]
pval <- coef(model)[ct_names[1], "Pr(>|t|)"]
ci <- confint(model)[ct_names[1],]
names(ci) <- c("CI_low","CI_high")
} else {
est <- NA; pval <- NA; ci <- c(CI_low=NA, CI_high=NA)
}
return(list(Estimate=est, CI_low=ci["CI_low"], CI_high=ci["CI_high"], Pvalue=pval))
}
# ANCOVA Table 2 & 3 with robust extraction
ancova_tab2 <- lapply(vars_table2, function(var){
model <- tryCatch(lm(as.formula(paste(var, "~", group_var, "+ AGE + SEX + EDUYR")), data=df_baseline, na.action=na.exclude), error=function(e) NULL)
if (!is.null(model) && length(rownames(coef(model))) > 1) {
extract_ancova(model, group_var)
} else {
list(Estimate=NA, CI_low=NA, CI_high=NA, Pvalue=NA)
}
})
names(ancova_tab2) <- vars_table2
ancova_tab3 <- lapply(vars_table3, function(var){
model <- tryCatch(lm(as.formula(paste(var, "~", group_var, "+ AGE + SEX + EDUYR")), data=df_baseline, na.action=na.exclude), error=function(e) NULL)
if (!is.null(model) && length(rownames(coef(model))) > 1) {
extract_ancova(model, group_var)
} else {
list(Estimate=NA, CI_low=NA, CI_high=NA, Pvalue=NA)
}
})
names(ancova_tab3) <- vars_table3
# Print pretty results
units_table2 <- c(height = "cm", weight = "kg", Waistcir = "cm", Hipcir = "cm", sysbp="mmHg", diabp="mmHg",
bmi="", ac="", whr="", pbcm = "%", pbf = "%", bmr = "kcal", ecw_tcw = "%", tbw_ffm = "%", PA50_total = "degree")
units_table3 <- c(ECW_ICW_upper = "%", ECW_ICW_lower = "%", Water_Lean_upper = "%", Water_Lean_lower = "%",
R_upper = "Ω", R_lower = "Ω", Xc_upper = "Ω", Xc_lower = "Ω", PA_upper = "degree", PA_lower = "degree",
R_H_upper = "Ω", R_H_lower = "Ω", Xc_H_upper = "Ω", Xc_H_lower = "Ω")
print_ancova_CI <- function(res_list, units=NULL) {
cat(sprintf("%-20s %-10s %-25s %-20s %-20s %-12s\n", "Variable", "Unit", "Adj. Diff (95%CI)", "Lower 95%CI", "Upper 95%CI", "P-value"))
for(v in names(res_list)) {
est <- res_list[[v]]$Estimate
ci_low <- res_list[[v]]$CI_low
ci_high <- res_list[[v]]$CI_high
pval <- res_list[[v]]$Pvalue
u <- if(!is.null(units) && !is.na(units[v])) units[v] else ""
cat(sprintf("%-20s %-10s %7.2f (%6.2f, %6.2f) %8.2f %8.2f %10.4f\n", v, u, est, ci_low, ci_high, ci_low, ci_high, pval))
}
}
cat("\n===== Table 2: Adjusted Group Difference (ANCOVA, 95% CI) =====\n")
print_ancova_CI(ancova_tab2, units_table2)
cat("\n===== Table 3: Adjusted Group Difference (ANCOVA, 95% CI) =====\n")
print_ancova_CI(ancova_tab3, units_table3)
# Optional save results
tbl2_df <- data.frame(
Variable = names(ancova_tab2),
Estimate = sapply(ancova_tab2, function(x) x$Estimate),
CI_low = sapply(ancova_tab2, function(x) x$CI_low),
CI_high = sapply(ancova_tab2, function(x) x$CI_high),
Pvalue = sapply(ancova_tab2, function(x) x$Pvalue),
Unit = units_table2[names(ancova_tab2)]
)
write.csv(tbl2_df, "table2_ANCOVA_results.csv", row.names=FALSE)
tbl3_df <- data.frame(
Variable = names(ancova_tab3),
Estimate = sapply(ancova_tab3, function(x) x$Estimate),
CI_low = sapply(ancova_tab3, function(x) x$CI_low),
CI_high = sapply(ancova_tab3, function(x) x$CI_high),
Pvalue = sapply(ancova_tab3, function(x) x$Pvalue),
Unit = units_table3[names(ancova_tab3)]
)
write.csv(tbl3_df, "table3_ANCOVA_results.csv", row.names=FALSE)
# Example violin plot
ggplot(df_baseline, aes(x=Change_Type, y=R_lower, fill=Change_Type)) +
geom_violin(trim=FALSE) +
geom_boxplot(width=0.1, fill="white") +
labs(title="R_lower by Group", y="R_lower") +
theme_minimal()
library(dplyr)
library(tableone)
library(ggplot2)
library(effsize)
df_baseline$SEX <- as.factor(df_baseline$SEX)
df_baseline$Change_Type <- as.factor(df_baseline$Change_Type)
df_baseline$Change_Type <- relevel(df_baseline$Change_Type, ref = "StableCN")
# Variables
vars_table2 <- c('height','weight','Waistcir','Hipcir','sysbp','diabp','bmi','ac','whr',
'pbcm','pbf','bmr','tbw_ffm','ecw_tcw','PA50_total')
vars_table3 <- c('ECW_ICW_upper','ECW_ICW_lower','Water_Lean_upper','Water_Lean_lower',
'R_upper','R_lower','Xc_upper','Xc_lower','PA_upper','PA_lower',
'R_H_upper','R_H_lower','Xc_H_upper','Xc_H_lower')
group_var <- "Change_Type"
# Dynamic contrast extraction: finds the right coefficient for each model
extract_ancova <- function(model, ref_level, cmp_level) {
contrast_name <- paste0(group_var, cmp_level)
ct_list <- grep(contrast_name, rownames(coef(model)), value=TRUE)
if(length(ct_list) > 0) {
est <- coef(model)[ct_list[1], "Estimate"]
pval <- coef(model)[ct_list[1], "Pr(>|t|)"]
ci <- confint(model)[ct_list[1],]
names(ci) <- c("CI_low","CI_high")
} else {
est <- NA; pval <- NA; ci <- c(CI_low=NA, CI_high=NA)
}
return(list(Estimate=est, CI_low=ci["CI_low"], CI_high=ci["CI_high"], Pvalue=pval))
}
ref_level <- levels(df_baseline[[group_var]])[1]
cmp_level <- levels(df_baseline[[group_var]])[2]
# ANCOVA for Table 2 and Table 3
ancova_tab2 <- lapply(vars_table2, function(var){
model <- tryCatch(lm(as.formula(paste(var, "~", group_var, "+ AGE + SEX + EDUYR")),
data=df_baseline, na.action=na.exclude), error=function(e) NULL)
if(!is.null(model)) {
extract_ancova(model, ref_level, cmp_level)
} else {
list(Estimate=NA, CI_low=NA, CI_high=NA, Pvalue=NA)
}
})
names(ancova_tab2) <- vars_table2
ancova_tab3 <- lapply(vars_table3, function(var){
model <- tryCatch(lm(as.formula(paste(var, "~", group_var + "+ AGE + SEX + EDUYR")),
data=df_baseline, na.action=na.exclude), error=function(e) NULL)
if(!is.null(model)) {
extract_ancova(model, ref_level, cmp_level)
} else {
list(Estimate=NA, CI_low=NA, CI_high=NA, Pvalue=NA)
}
})
names(ancova_tab3) <- vars_table3
# Print results
units_table2 <- c(height = "cm", weight = "kg", Waistcir = "cm", Hipcir = "cm", sysbp="mmHg", diabp="mmHg",
bmi="", ac="", whr="", pbcm = "%", pbf = "%", bmr = "kcal", ecw_tcw = "%", tbw_ffm = "%", PA50_total = "degree")
units_table3 <- c(ECW_ICW_upper = "%", ECW_ICW_lower = "%", Water_Lean_upper = "%", Water_Lean_lower = "%",
R_upper = "Ω", R_lower = "Ω", Xc_upper = "Ω", Xc_lower = "Ω", PA_upper = "degree", PA_lower = "degree",
R_H_upper = "Ω", R_H_lower = "Ω", Xc_H_upper = "Ω", Xc_H_lower = "Ω")
print_ancova_CI <- function(res_list, units=NULL) {
cat(sprintf("%-20s %-10s %-25s %-20s %-20s %-12s\n", "Variable", "Unit", "Adj. Diff (95%CI)", "Lower 95%CI", "Upper 95%CI", "P-value"))
for(v in names(res_list)) {
est <- res_list[[v]]$Estimate
ci_low <- res_list[[v]]$CI_low
ci_high <- res_list[[v]]$CI_high
pval <- res_list[[v]]$Pvalue
u <- if(!is.null(units) && !is.na(units[v])) units[v] else ""
cat(sprintf("%-20s %-10s %7.2f (%6.2f, %6.2f) %8.2f %8.2f %10.4f\n", v, u, est, ci_low, ci_high, ci_low, ci_high, pval))
}
}
cat("\n===== Table 2: Adjusted Group Difference (ANCOVA, 95% CI) =====\n")
print_ancova_CI(ancova_tab2, units_table2)
cat("\n===== Table 3: Adjusted Group Difference (ANCOVA, 95% CI) =====\n")
print_ancova_CI(ancova_tab3, units_table3)
# 1. Load required packages
library(dplyr)
library(tableone)
library(ggplot2)
library(effsize)
# 2. Ensure proper factor conversion
df_baseline$SEX <- as.factor(df_baseline$SEX)
df_baseline$Change_Type <- as.factor(df_baseline$Change_Type)
# 3. Define variables for each table
vars_table1 <- c('SEX','AGE','EDUYR','gds','kdsq','visitcount','MMSE',
'SNSB_attention','SNSB_language','SNSB_visuospatial','SNSB_memory','SNSB_frontal')
vars_table2 <- c('height','weight','Waistcir','Hipcir','sysbp','diabp','bmi','ac','whr',
'pbcm','pbf','bmr','tbw_ffm','ecw_tcw','PA50_total')
vars_table3 <- c('ECW_ICW_upper','ECW_ICW_lower','Water_Lean_upper','Water_Lean_lower',
'R_upper','R_lower','Xc_upper','Xc_lower','PA_upper','PA_lower',
'R_H_upper','R_H_lower','Xc_H_upper','Xc_H_lower')
group_var <- "Change_Type"
covars <- c("AGE", "SEX", "EDUYR")
# 4. Table 1: Baseline descriptive statistics and group comparison
# Make Table 1 (raw statistics, t-test/U-test/chi-square/fisher & effect size)
tab1 <- CreateTableOne(vars=vars_table1, strata=group_var, data=df_baseline)
print(tab1, showAllLevels=TRUE, quote=TRUE, noSpaces=TRUE)
# Helper: Group comparison for Table 1, including effect sizes
get_pvals_es <- function(varlist, groupvar, df){
res <- lapply(varlist, function(v){
vals <- df[[v]]; g <- df[[groupvar]]
non_missing <- !(is.na(vals) | is.na(g))
vals_nm <- vals[non_missing]
g_nm <- g[non_missing]
pval <- NA; effsize <- NA
if (length(unique(g_nm)) != 2) return(list(pval=NA,effsize=NA))
if (is.numeric(vals_nm) | is.integer(vals_nm)){
p_norm <- tryCatch(shapiro.test(vals_nm)$p.value,error=function(e) NA)
if (!is.na(p_norm) && p_norm > 0.05){
ttest <- t.test(vals_nm ~ g_nm)
pval <- ttest$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm)$estimate
}else{
wilcox <- wilcox.test(vals_nm ~ g_nm)
pval <- wilcox$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm, hedges.correction=TRUE)$estimate
}
}else{
tbl <- table(vals_nm, g_nm)
pval <- if(any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
effsize <- NA
}
return(list(pval=pval,effsize=effsize))
})
names(res) <- varlist
return(res)
}
result_table1 <- get_pvals_es(vars_table1, group_var, df_baseline)
print(result_table1)
# 5. Helper function: Safe extraction of group effect from ANCOVA
get_group_coef <- function(res, group_var, df) {
levs <- levels(df[[group_var]])
target_lev <- levs[2]
target_name <- grep(target_lev, rownames(coef(res)), value=TRUE)
if(length(target_name) == 1) {
pval <- coef(res)[target_name, "Pr(>|t|)"]
est <- coef(res)[target_name, "Estimate"]
} else {
pval <- NA
est <- NA
}
return(list(pval=pval, estimate=est))
}
# 6. Table 2: Anthropometry & whole-body composition (ANCOVA for each variable)
ancova_tab2 <- lapply(vars_table2, function(v){
formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
model <- lm(formula, data=df_baseline, na.action=na.exclude)
res <- summary(model)
grp <- get_group_coef(res, group_var, df_baseline)
return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab2) <- vars_table2
# 7. Table 3: Segmental bioimpedance (ANCOVA for each variable)
ancova_tab3 <- lapply(vars_table3, function(v){
formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
model <- lm(formula, data=df_baseline, na.action=na.exclude)
res <- summary(model)
grp <- get_group_coef(res, group_var, df_baseline)
return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab3) <- vars_table3
# 8. Print nicely formatted ANCOVA results (Table 2 & Table 3) with units
print_ancova <- function(res_list, units = NULL) {
for (v in names(res_list)) {
est <- res_list[[v]]$estimate
pval <- res_list[[v]]$pval
u <- if(!is.null(units) && !is.na(units[v])) units[v] else ""
cat(sprintf("%-25s Estimate: %8.3f %-5s | p-value: %.4f\n", v, est, u, pval))
}
}
units_table2 <- c(height = "cm", weight = "kg", BMI = "", whr = "", pbcm = "%", pbf = "%", bmr = "kcal", ecw_tcw = "%", tbw_ffm = "%", PA50_total = "degree")
units_table3 <- c(
ECW_ICW_upper = "%", ECW_ICW_lower = "%", Water_Lean_upper = "%", Water_Lean_lower = "%",
R_upper = "Ω", R_lower = "Ω", Xc_upper = "Ω", Xc_lower = "Ω", PA_upper = "degree", PA_lower = "degree",
R_H_upper = "Ω", R_H_lower = "Ω", Xc_H_upper = "Ω", Xc_H_lower = "Ω"
)
# Table 2 Results
cat("\n===== Table 2: ANCOVA Results =====\n")
print_ancova(ancova_tab2, units_table2)
# Table 3 Results
cat("\n===== Table 3: ANCOVA Results =====\n")
print_ancova(ancova_tab3, units_table3)
# 9. Visualization: Example violin plot (modify for any variable you need)
ggplot(df_baseline, aes(x=Change_Type, y=R_lower, fill=Change_Type)) +
geom_violin(trim=FALSE) +
geom_boxplot(width=0.1, fill="white") +
labs(title="R_lower by Group", y="R_lower") +
theme_minimal()
# 10. Export baseline summary tables
write.csv(print(tab1, quote = TRUE, noSpaces = TRUE), "table1_baseline.csv")
# Optional: You can extract and export ANCOVA summary results if needed, e.g.
tbl2_results <- sapply(names(ancova_tab2), function(var) c(Estimate = ancova_tab2[[var]]$estimate, Pvalue = ancova_tab2[[var]]$pval))
write.csv(tbl2_results, "table2_ancova.csv")
tbl3_results <- sapply(names(ancova_tab3), function(var) c(Estimate = ancova_tab3[[var]]$estimate, Pvalue = ancova_tab3[[var]]$pval))
write.csv(tbl3_results, "table3_ancova.csv")
library(tableone)
library(effsize)
df_baseline$SEX <- as.factor(df_baseline$SEX)
df_baseline$Change_Type <- as.factor(df_baseline$Change_Type)
vars_table1 <- c('SEX','AGE','EDUYR','gds','kdsq','visitcount','MMSE',
'SNSB_attention','SNSB_language','SNSB_visuospatial','SNSB_memory','SNSB_frontal')
vars_table2 <- c('height','weight','Waistcir','Hipcir','sysbp','diabp','bmi','ac','whr',
'pbcm','pbf','bmr','tbw_ffm','ecw_tcw','PA50_total')
vars_table3 <- c('ECW_ICW_upper','ECW_ICW_lower','Water_Lean_upper','Water_Lean_lower',
'R_upper','R_lower','Xc_upper','Xc_lower','PA_upper','PA_lower',
'R_H_upper','R_H_lower','Xc_H_upper','Xc_H_lower')
group_var <- "Change_Type"
covars <- c("AGE", "SEX", "EDUYR")
tab1 <- CreateTableOne(vars=vars_table1, strata=group_var, data=df_baseline)
print(tab1, showAllLevels=TRUE, quote=TRUE, noSpaces=TRUE)
get_pvals_es <- function(varlist, groupvar, df){
res <- lapply(varlist, function(v){
vals <- df[[v]]; g <- df[[groupvar]]
non_missing <- !(is.na(vals) | is.na(g))
vals_nm <- vals[non_missing]
g_nm <- g[non_missing]
pval <- NA; effsize <- NA
if (length(unique(g_nm)) != 2) return(list(pval=NA,effsize=NA))
if (is.numeric(vals_nm) | is.integer(vals_nm)){
p_norm <- tryCatch(shapiro.test(vals_nm)$p.value,error=function(e) NA)
if (!is.na(p_norm) && p_norm > 0.05){
ttest <- t.test(vals_nm ~ g_nm)
pval <- ttest$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm)$estimate
}else{
wilcox <- wilcox.test(vals_nm ~ g_nm)
pval <- wilcox$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm, hedges.correction=TRUE)$estimate
}
}else{
tbl <- table(vals_nm, g_nm)
pval <- if(any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
effsize <- NA
}
return(list(pval=pval,effsize=effsize))
})
names(res) <- varlist
return(res)
}
result_table1 <- get_pvals_es(vars_table1, group_var, df_baseline)
print(result_table1)
get_group_coef <- function(res, group_var, df) {
levs <- levels(df[[group_var]])
target_lev <- levs[2]
target_name <- grep(target_lev, rownames(coef(res)), value=TRUE)
if(length(target_name) == 1) {
pval <- coef(res)[target_name, "Pr(>|t|)"]
est <- coef(res)[target_name, "Estimate"]
} else {
pval <- NA
est <- NA
}
return(list(pval=pval, estimate=est))
}
ancova_tab2 <- lapply(vars_table2, function(v){
formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR + gds"))
model <- lm(formula, data=df_baseline, na.action=na.exclude)
res <- summary(model)
grp <- get_group_coef(res, group_var, df_baseline)
return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab2) <- vars_table2
ancova_tab3 <- lapply(vars_table3, function(v){
formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR + gds"))
model <- lm(formula, data=df_baseline, na.action=na.exclude)
res <- summary(model)
grp <- get_group_coef(res, group_var, df_baseline)
return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab3) <- vars_table3
print_ancova <- function(res_list, units = NULL) {
for (v in names(res_list)) {
est <- res_list[[v]]$estimate
pval <- res_list[[v]]$pval
u <- if(!is.null(units) && !is.na(units[v])) units[v] else ""
cat(sprintf("%-25s Estimate: %8.3f %-5s | p-value: %.4f\n", v, est, u, pval))
}
}
units_table2 <- c(height = "cm", weight = "kg", BMI = "", whr = "", pbcm = "%", pbf = "%", bmr = "kcal", ecw_tcw = "%", tbw_ffm = "%", PA50_total = "degree")
units_table3 <- c(
ECW_ICW_upper = "%", ECW_ICW_lower = "%", Water_Lean_upper = "%", Water_Lean_lower = "%",
R_upper = "Ω", R_lower = "Ω", Xc_upper = "Ω", Xc_lower = "Ω", PA_upper = "degree", PA_lower = "degree",
R_H_upper = "Ω", R_H_lower = "Ω", Xc_H_upper = "Ω", Xc_H_lower = "Ω"
)
cat("\n===== Table 2: ANCOVA Results =====\n")
print_ancova(ancova_tab2, units_table2)
cat("\n===== Table 3: ANCOVA Results =====\n")
print_ancova(ancova_tab3, units_table3)
ggplot(df_baseline, aes(x=Change_Type, y=R_lower, fill=Change_Type)) +
geom_violin(trim=FALSE) +
geom_boxplot(width=0.1, fill="white") +
labs(title="R_lower by Group", y="R_lower") +
theme_minimal()
write.csv(print(tab1, quote = TRUE, noSpaces = TRUE), "table1_baseline.csv")
tbl2_results <- sapply(names(ancova_tab2), function(var) c(Estimate = ancova_tab2[[var]]$estimate, Pvalue = ancova_tab2[[var]]$pval))
write.csv(tbl2_results, "table2_ancova.csv")
tbl3_results <- sapply(names(ancova_tab3), function(var) c(Estimate = ancova_tab3[[var]]$estimate, Pvalue = ancova_tab3[[var]]$pval))
write.csv(tbl3_results, "table3_ancova.csv")
library(tableone)
library(effsize)
df_baseline$SEX <- as.factor(df_baseline$SEX)
df_baseline$Change_Type <- as.factor(df_baseline$Change_Type)
vars_table1 <- c('SEX','AGE','EDUYR','gds','kdsq','visitcount','MMSE',
'SNSB_attention','SNSB_language','SNSB_visuospatial','SNSB_memory','SNSB_frontal')
vars_table2 <- c('height','weight','Waistcir','Hipcir','sysbp','diabp','bmi','ac','whr',
'pbcm','pbf','bmr','tbw_ffm','ecw_tcw','PA50_total')
vars_table3 <- c('ECW_ICW_upper','ECW_ICW_lower','Water_Lean_upper','Water_Lean_lower',
'R_upper','R_lower','Xc_upper','Xc_lower','PA_upper','PA_lower',
'R_H_upper','R_H_lower','Xc_H_upper','Xc_H_lower')
group_var <- "Change_Type"
covars <- c("AGE", "SEX", "EDUYR")
tab1 <- CreateTableOne(vars=vars_table1, strata=group_var, data=df_baseline)
print(tab1, showAllLevels=TRUE, quote=TRUE, noSpaces=TRUE)
get_pvals_es <- function(varlist, groupvar, df){
res <- lapply(varlist, function(v){
vals <- df[[v]]; g <- df[[groupvar]]
non_missing <- !(is.na(vals) | is.na(g))
vals_nm <- vals[non_missing]
g_nm <- g[non_missing]
pval <- NA; effsize <- NA
if (length(unique(g_nm)) != 2) return(list(pval=NA,effsize=NA))
if (is.numeric(vals_nm) | is.integer(vals_nm)){
p_norm <- tryCatch(shapiro.test(vals_nm)$p.value,error=function(e) NA)
if (!is.na(p_norm) && p_norm > 0.05){
ttest <- t.test(vals_nm ~ g_nm)
pval <- ttest$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm)$estimate
}else{
wilcox <- wilcox.test(vals_nm ~ g_nm)
pval <- wilcox$p.value
effsize <- effsize::cohen.d(vals_nm, g_nm, hedges.correction=TRUE)$estimate
}
}else{
tbl <- table(vals_nm, g_nm)
pval <- if(any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
effsize <- NA
}
return(list(pval=pval,effsize=effsize))
})
names(res) <- varlist
return(res)
}
result_table1 <- get_pvals_es(vars_table1, group_var, df_baseline)
print(result_table1)
get_group_coef <- function(res, group_var, df) {
levs <- levels(df[[group_var]])
target_lev <- levs[2]
target_name <- grep(target_lev, rownames(coef(res)), value=TRUE)
if(length(target_name) == 1) {
pval <- coef(res)[target_name, "Pr(>|t|)"]
est <- coef(res)[target_name, "Estimate"]
} else {
pval <- NA
est <- NA
}
return(list(pval=pval, estimate=est))
}
ancova_tab2 <- lapply(vars_table2, function(v){
formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
model <- lm(formula, data=df_baseline, na.action=na.exclude)
res <- summary(model)
grp <- get_group_coef(res, group_var, df_baseline)
return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab2) <- vars_table2
ancova_tab3 <- lapply(vars_table3, function(v){
formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
model <- lm(formula, data=df_baseline, na.action=na.exclude)
res <- summary(model)
grp <- get_group_coef(res, group_var, df_baseline)
return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab3) <- vars_table3
print_ancova <- function(res_list, units = NULL) {
for (v in names(res_list)) {
est <- res_list[[v]]$estimate
pval <- res_list[[v]]$pval
u <- if(!is.null(units) && !is.na(units[v])) units[v] else ""
cat(sprintf("%-25s Estimate: %8.3f %-5s | p-value: %.4f\n", v, est, u, pval))
}
}
units_table2 <- c(height = "cm", weight = "kg", BMI = "", whr = "", pbcm = "%", pbf = "%", bmr = "kcal", ecw_tcw = "%", tbw_ffm = "%", PA50_total = "degree")
units_table3 <- c(
ECW_ICW_upper = "%", ECW_ICW_lower = "%", Water_Lean_upper = "%", Water_Lean_lower = "%",
R_upper = "Ω", R_lower = "Ω", Xc_upper = "Ω", Xc_lower = "Ω", PA_upper = "degree", PA_lower = "degree",
R_H_upper = "Ω", R_H_lower = "Ω", Xc_H_upper = "Ω", Xc_H_lower = "Ω"
)
cat("\n===== Table 2: ANCOVA Results =====\n")
print_ancova(ancova_tab2, units_table2)
cat("\n===== Table 3: ANCOVA Results =====\n")
print_ancova(ancova_tab3, units_table3)
ggplot(df_baseline, aes(x=Change_Type, y=R_lower, fill=Change_Type)) +
geom_violin(trim=FALSE) +
geom_boxplot(width=0.1, fill="white") +
labs(title="R_lower by Group", y="R_lower") +
theme_minimal()
write.csv(print(tab1, quote = TRUE, noSpaces = TRUE), "table1_baseline.csv")
tbl2_results <- sapply(names(ancova_tab2), function(var) c(Estimate = ancova_tab2[[var]]$estimate, Pvalue = ancova_tab2[[var]]$pval))
write.csv(tbl2_results, "table2_ancova.csv")
tbl3_results <- sapply(names(ancova_tab3), function(var) c(Estimate = ancova_tab3[[var]]$estimate, Pvalue = ancova_tab3[[var]]$pval))
write.csv(tbl3_results, "table3_ancova.csv")
