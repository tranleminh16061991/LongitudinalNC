plt1.legend <- plot_lmer_interaction_with_p(df_long.analysis, response = "MMSE", show.legend = TRUE) +
guides(color = guide_legend(nrow = 1)) +
theme(legend.position = "right", text = element_text(size = 8))
# Extract legend as a separate grob
legend_b <- cowplot::get_legend(plt1.legend)
(combined_plot <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, combined_plot,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
#cowplot::save_plot("Longitudinal_Analysis_COGS_all.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
plot_lmer_interaction_with_p <- function(data, response = "TAR",
xvar = "elapsed_years", groupvar = "Change_Type",
covariates = c("AGE", "SEX", "EDUYR"),
colors = c("StableCN" = "#0072B2", "CNtransitMCI" = "#E69F00"), show.legend = FALSE) {
# Build formulas
full_formula <- paste0(response, " ~ ", xvar, "*", groupvar, " + ",
paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
reduced_formula <- paste0(response, " ~ ", xvar, " + ", groupvar, " + ",
paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
# Fit models with REML=FALSE for LRT
full_mod <- lmer(as.formula(full_formula), data = data, REML = FALSE)
reduced_mod <- lmer(as.formula(reduced_formula), data = data, REML = FALSE)
# Likelihood ratio test for omnibus interaction
lrt <- anova(reduced_mod, full_mod)
chi_sq <- lrt$Chisq[2]
df <- lrt$`Df`[2]
p_val <- lrt$`Pr(>Chisq)`[2]
# Add significance stars for omnibus p-value
stars <- if (p_val < 0.001) "***" else if (p_val < 0.01) "**" else if (p_val < 0.05) "*" else ""
omnibus_label <- sprintf("Interaction: Chi-sq(%d) = %.2f, p = %.4f%s", df, chi_sq, p_val, stars)
# Extract individual interaction p-values from full model
coef_sum <- summary(full_mod)$coefficients
inter_rows <- grep(paste0(xvar, ":", groupvar), rownames(coef_sum))
pvals <- coef_sum[inter_rows, "Pr(>|t|)"]
names_pvals <- gsub(paste0(xvar, ":"), "", rownames(coef_sum)[inter_rows])
names_pvals <- gsub(groupvar, "", names_pvals)
pval_labels <- sapply(seq_along(pvals), function(i) {
pval <- pvals[i]
stars <- if (pval < 0.001) "***" else if (pval < 0.01) "**" else if (pval < 0.05) "*" else ""
paste0("Stable X ", names_pvals[i], ": p = ", round(signif(pval, 4),4), stars)
})
annotation_text <- paste(c(pval_labels), collapse = "\n")
# Build base plot
p <- plot_model(full_mod, type = "pred", terms = c(xvar, groupvar)) +
labs(title = "", x = xvar, y = response) +
scale_color_manual(values = colors) +
scale_fill_manual(values = colors) +
theme_minimal() +
theme(plot.margin=unit(c(0.5,0.5,2,0.5), "lines"))  # extra bottom margin
if(!show.legend){
p <- p +  theme(legend.position = "none")
}
# Add individual p-values as an annotation near top left
x_anno <- max(data[[xvar]], na.rm = TRUE) * 0.1
y_anno <- max(data[[response]], na.rm = TRUE) * 0.75
p <- p + annotate("text", x = x_anno, y = y_anno, label = annotation_text, size = 3, hjust = 0, color = "black")
# Add omnibus LRT Chi-square test below x-axis label with stars
y_axis_min <- min(data[[response]], na.rm = TRUE)
offset <- 0.1 * abs(y_axis_min)  # offset for placing below x-axis
p + annotate("text", x = mean(range(data[[xvar]], na.rm = TRUE)), y = y_axis_min - offset,
label = omnibus_label, size = 3, color = "black", hjust = 0.5)
#return(p)
}
(plt1 <- plot_lmer_interaction_with_p(df_long.analysis, response = "MMSE") )
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_attention"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_language") )
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_visuospatial") )
(plt5 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_memory") )
(plt6 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_frontal"))
# Create first plot with legend on top and smaller text size
plt1.legend <- plot_lmer_interaction_with_p(df_long.analysis, response = "MMSE", show.legend = TRUE) +
guides(color = guide_legend(nrow = 1)) +
theme(legend.position = "right", text = element_text(size = 8))
# Extract legend as a separate grob
legend_b <- cowplot::get_legend(plt1.legend)
(combined_plot <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, combined_plot,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
#cowplot::save_plot("Longitudinal_Analysis_COGS_all.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "bmi"))
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ac"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "whr"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "pbcm"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "pbf"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "bmr"))
(plt6 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "tbw_ffm"))
(psd.tests <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,plt7
ncol = 3, label_size =10))
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "bmi"))
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ac"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "whr"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "pbcm"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "pbf"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "bmr"))
(plt6 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "tbw_ffm"))
(psd.tests <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, psd.tests,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
cowplot::save_plot("Longitudinal_Analysis_psd_OnlyMCI.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "R_H_upper"))
(plt2 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "R_H_lower"))
(plt3 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_H_upper"))
(plt4 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_H_lower"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ac"))
(psd.flat.ratios <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, psd.flat.ratios,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
cowplot::save_plot("Longitudinal_Analysis_psd_flat_ratios.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ecw_tcw"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "PA50_total"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "ECW_ICW_upper"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "ECW_ICW_lower"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Water_Lean_upper"))
(psd.tests <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, psd.tests,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
cowplot::save_plot("Longitudinal_Analysis_psd_ratios_OnlyMCI.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Water_Lean_lower"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "R_upper"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "R_lower"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_upper"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "PA_upper"))
(plt6 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "PA_lower"))
(psd.flat <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, psd.flat,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
cowplot::save_plot("Longitudinal_Analysis_psd_flat_OnlyMCI.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "R_H_upper"))
(plt2 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "R_H_lower"))
(plt3 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_H_upper"))
(plt4 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_H_lower"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ac"))
(psd.flat.ratios <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, psd.flat.ratios,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
cowplot::save_plot("Longitudinal_Analysis_psd_flat_ratios.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ecw_tcw"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "PA50_total"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "ECW_ICW_upper"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "ECW_ICW_lower"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Water_Lean_upper"))
(psd.tests <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,
ncol = 3, label_size =10))
combined <- cowplot::plot_grid (legend_b, psd.tests,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
cowplot::save_plot("Longitudinal_Analysis_psd_ratios_OnlyMCI.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
variables <- c("bmi", "whr", "pbcm", "pbf", "bmr", "tbw_ffm", "ecw_tcw", "PA50_total")
reference_group <- "StableCN"
comparison_groups <- c("CNtransitMCI")
colors.legend <- c("StableCN" = "#0072B2", "CNtransitMCI" = "#E69F00")
results <- lapply(variables, function(var) {
analyze_longitudinal_trends(data = df_long.analysis, response = var, groupvar = "Change_Type", reference_group = reference_group, comparison_groups = comparison_groups)
})
# Name results
names(results) <- variables
model_summary_list <- lapply(results, function(result) {
result$model_summary
})
# Extract all summaries into one table
all_summaries <- dplyr::bind_rows(lapply(results, function(x) x$model_summary), .id = "Variable")
plot_pvalues(model_summary_list)
(plt.slopes <- plot_slopes(model_summary_list, colors = colors.legend))
all_summaries
cowplot::save_plot("Longitudinal_Analysis_Slopes_all.pdf", plt.slopes, ncol = 1,  base_width =13, base_height = 9.0)
variables <- c("ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower","R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower","R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower")
results <- lapply(variables, function(var) {
analyze_longitudinal_trends(data = df_long.analysis, response = var, groupvar = "Change_Type", reference_group = reference_group, comparison_groups = comparison_groups)
})
# Name results
names(results) <- variables
model_summary_list <- lapply(results, function(result) {
result$model_summary
})
# Extract all summaries into one table
all_summaries <- dplyr::bind_rows(lapply(results, function(x) x$model_summary), .id = "Variable")
plot_pvalues(model_summary_list)
(plt.slopes <- plot_slopes(model_summary_list, colors = colors.legend))
all_summaries
cowplot::save_plot("Longitudinal_Analysis_Slopes_FOOOF_.pdf", plt.slopes, ncol = 1,  base_width =13, base_height = 9.0)
library(ggsignif)
model_contrasts_list <- lapply(results, function(result) {
result$contrasts_df
})
# Suppose you have group slopes already summarized per variable:
group_slopes <- data.frame(
Change_Type = c("StableCN", "CNtransitMCI"),
slope = c(0.145, 0.668, 0.528),      # Replace with your actual estimates
lower = c(-0.0161, 0.0329, 0.1503),
upper = c(0.306, 1.304, 0.905)
)
library(ggsignif)
model_contrasts_list <- lapply(results, function(result) {
result$contrasts_df
})
# Suppose you have group slopes already summarized per variable:
group_slopes <- data.frame(
Change_Type = c("StableCN", "CNtransitMCI"),
slope = c(0.145, 0.668),
lower = c(-0.0161, 0.0329),
upper = c(0.306, 1.304)
)
# Set factor levels explicitly so "Stable" is first:
group_slopes <- group_slopes %>%
mutate(Change_Type = factor(Change_Type, levels = c("StableCN", "CNtransitMCI")))
# Your contrasts data with simple group names split for ggsignif
contrast_df <- model_contrasts_list$beta %>%
rename(
Contrast = contrast,
diff = estimate,
lower = lower.CL,
upper = upper.CL,
p_value = p.value
) %>%
mutate(
signif_stars = ifelse(p_value < 0.001, "***",
ifelse(p_value < 0.01, "**",
ifelse(p_value < 0.05, "*", ""))),
# Split contrast strings into pairs for comparisons
group1 = sub(" -.*", "", Contrast),
group2 = sub(".*- ", "", Contrast),
p.label = paste0(round(p_value,3),signif_stars)
)
plot_lmer_model_with_interaction_p <-function(data, response = "SPR",
xvar = "elapsed_years", groupvar = "Change_Type",
covariates = c("AGE", "SEX", "EDUYR"),
colors = c("StableCN" = "#0072B2", "CNtransitMCI" = "#E69F00"),
n_points = 100, show.legend = FALSE) {
# Fit the model with lmerTest to get p-values
formula_str <- paste0(response, " ~ ", xvar, "*", groupvar, " + ",
paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
mod <- lmer(formula_str, data = data)
# Create prediction grid for fixed effects
pred_data <- expand.grid(
elapsed_years = seq(min(data[[xvar]], na.rm = TRUE),
max(data[[xvar]], na.rm = TRUE),
length.out = n_points),
Group = unique(data[[groupvar]])
)
for (cov in covariates) {
if (is.numeric(data[[cov]])) {
pred_data[[cov]] <- median(data[[cov]], na.rm = TRUE)
} else if (is.factor(data[[cov]])) {
pred_data[[cov]] <- levels(data[[cov]])[1]
}
}
title <-  paste("Predicted", response, "Trajectories by Group")
# Predict fixed effects only i.e Smooth overall preidtcion for MCI or CN
pred_data$predicted <- predict(mod, newdata = pred_data, re.form = NA)
# Predict individual subject trajectories (include random effects)
data$predicted_indiv <- predict(mod, newdata = data, re.form = NULL)
sig_stars <- function(p) {
if (p < 0.001) "***" else if (p < 0.01) "**" else if (p < 0.05) "*" else ""
}
# Extract interaction p-value for elapsed_years:Group
coef_summary <- summary(mod)$coefficients
interaction_term <- paste0(xvar, ":", groupvar, unique(data[[groupvar]])[2])
# The exact name to match can be tricky, check which name matches in coef_summary
inter_pval <- coef_summary[grep("elapsed_years:Group", rownames(coef_summary)), "Pr(>|t|)"]
pval_label <- paste0(paste0("Time", " x ", groupvar,", p = "), round(signif(inter_pval, 3),3), sig_stars(signif(inter_pval, 3)))
# Create the plot
p <- ggplot() +
geom_line(data = data,
aes_string(x = xvar, y = "predicted_indiv", group = "USUBJID", color = groupvar),
alpha = 0.3, size = 0.5) +
geom_line(data = pred_data,
aes(x = elapsed_years, y = predicted, color = Group),
size = 1.5) +
labs(title = "",
x = xvar,
y = response) +
theme_minimal() +
scale_color_manual(values = colors)+
annotate("text", x = Inf, y = -Inf, label = pval_label, hjust = 1.0, vjust = -1, size = 3.0, color = "black")
#print(summary(mod))
if(!show.legend){
p <- p + theme(legend.position = "none")
}
return(p)
}
plot_lmer_model_with_interaction_p <-function(data, response = "whr",
xvar = "elapsed_years", groupvar = "Change_Type",
covariates = c("AGE", "SEX", "EDUYR"),
colors = c("StableCN" = "#0072B2", "CNtransitMCI" = "#E69F00"),
n_points = 100, show.legend = FALSE) {
# Fit the model with lmerTest to get p-values
formula_str <- paste0(response, " ~ ", xvar, "*", groupvar, " + ",
paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
mod <- lmer(formula_str, data = data)
# Create prediction grid for fixed effects
pred_data <- expand.grid(
elapsed_years = seq(min(data[[xvar]], na.rm = TRUE),
max(data[[xvar]], na.rm = TRUE),
length.out = n_points),
Group = unique(data[[groupvar]])
)
for (cov in covariates) {
if (is.numeric(data[[cov]])) {
pred_data[[cov]] <- median(data[[cov]], na.rm = TRUE)
} else if (is.factor(data[[cov]])) {
pred_data[[cov]] <- levels(data[[cov]])[1]
}
}
title <-  paste("Predicted", response, "Trajectories by Group")
# Predict fixed effects only i.e Smooth overall preidtcion for MCI or CN
pred_data$predicted <- predict(mod, newdata = pred_data, re.form = NA)
# Predict individual subject trajectories (include random effects)
data$predicted_indiv <- predict(mod, newdata = data, re.form = NULL)
sig_stars <- function(p) {
if (p < 0.001) "***" else if (p < 0.01) "**" else if (p < 0.05) "*" else ""
}
# Extract interaction p-value for elapsed_years:Group
coef_summary <- summary(mod)$coefficients
interaction_term <- paste0(xvar, ":", groupvar, unique(data[[groupvar]])[2])
# The exact name to match can be tricky, check which name matches in coef_summary
inter_pval <- coef_summary[grep("elapsed_years:Group", rownames(coef_summary)), "Pr(>|t|)"]
pval_label <- paste0(paste0("Time", " x ", groupvar,", p = "), round(signif(inter_pval, 3),3), sig_stars(signif(inter_pval, 3)))
# Create the plot
p <- ggplot() +
geom_line(data = data,
aes_string(x = xvar, y = "predicted_indiv", group = "USUBJID", color = groupvar),
alpha = 0.3, size = 0.5) +
geom_line(data = pred_data,
aes(x = elapsed_years, y = predicted, color = Group),
size = 1.5) +
labs(title = "",
x = xvar,
y = response) +
theme_minimal() +
scale_color_manual(values = colors)+
annotate("text", x = Inf, y = -Inf, label = pval_label, hjust = 1.0, vjust = -1, size = 3.0, color = "black")
#print(summary(mod))
if(!show.legend){
p <- p + theme(legend.position = "none")
}
return(p)
}
df_long.analysis <- df_long.analysis %>%filter(Change_Type %in% c("StableCN","CNtransitMCI"))
(plt1 <- plot_lmer_model_with_interaction_p(df_long.analysis, response = "MMSE"))
df_long.analysis <- df_long.analysis %>%filter(Change_Type %in% c("StableCN","CNtransitMCI"))
(plt1 <- plot_lmer_model_with_interaction_p(df_long.analysis, response = "MMSE"))
(plt1 <- plot_lmer_model_with_interaction_p(df_long.analysis, response = "bmi"))
library(ggsignif)
model_contrasts_list <- lapply(results, function(result) {
result$contrasts_df
})
# Suppose you have group slopes already summarized per variable:
group_slopes <- data.frame(
Change_Type = c("StableCN", "CNtransitMCI"),
slope = c(0.145, 0.668),
lower = c(-0.0161, 0.0329),
upper = c(0.306, 1.304)
)
# Set factor levels explicitly so "Stable" is first:
group_slopes <- group_slopes %>%
mutate(Change_Type = factor(Change_Type, levels = c("StableCN", "CNtransitMCI")))
# Your contrasts data with simple group names split for ggsignif
contrast_df <- model_contrasts_list$beta %>%
rename(
Contrast = contrast,
diff = estimate,
lower = lower.CL,
upper = upper.CL,
p_value = p.value
) %>%
mutate(
signif_stars = ifelse(p_value < 0.001, "***",
ifelse(p_value < 0.01, "**",
ifelse(p_value < 0.05, "*", ""))),
# Split contrast strings into pairs for comparisons
group1 = sub(" -.*", "", Contrast),
group2 = sub(".*- ", "", Contrast),
p.label = paste0(round(p_value,3),signif_stars)
)
library(ggsignif)
model_contrasts_list <- lapply(results, function(result) {
result$contrasts_df
})
# Suppose you have group slopes already summarized per variable:
group_slopes <- data.frame(
Change_Type = c("StableCN", "CNtransitMCI"),
slope = c(0.145, 0.668),
lower = c(-0.0161, 0.0329),
upper = c(0.306, 1.304)
)
# Set factor levels explicitly so "Stable" is first:
group_slopes <- group_slopes %>%
mutate(Change_Type = factor(Change_Type, levels = c("StableCN", "CNtransitMCI")))
# Comparisons list for geom_signif (each pair a vector)
comparisons <- split(contrast_df, seq(nrow(contrast_df))) %>%
lapply(function(row) as.character(c(row$group1, row$group2)))
plot_lmer_model_with_interaction_p <-function(data, response = "whr",
xvar = "elapsed_years", groupvar = "Change_Type",
covariates = c("AGE", "SEX", "EDUYR"),
colors = c("StableCN" = "#0072B2", "CNtransitMCI" = "#E69F00"),
n_points = 100, show.legend = FALSE) {
# Fit the model with lmerTest to get p-values
formula_str <- paste0(response, " ~ ", xvar, "*", groupvar, " + ",
paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
mod <- lmer(formula_str, data = data)
# Create prediction grid for fixed effects
pred_data <- expand.grid(
elapsed_years = seq(min(data[[xvar]], na.rm = TRUE),
max(data[[xvar]], na.rm = TRUE),
length.out = n_points),
Group = unique(data[[groupvar]])
)
for (cov in covariates) {
if (is.numeric(data[[cov]])) {
pred_data[[cov]] <- median(data[[cov]], na.rm = TRUE)
} else if (is.factor(data[[cov]])) {
pred_data[[cov]] <- levels(data[[cov]])[1]
}
}
title <-  paste("Predicted", response, "Trajectories by Group")
# Predict fixed effects only i.e Smooth overall preidtcion for MCI or CN
pred_data$predicted <- predict(mod, newdata = pred_data, re.form = NA)
# Predict individual subject trajectories (include random effects)
data$predicted_indiv <- predict(mod, newdata = data, re.form = NULL)
sig_stars <- function(p) {
if (p < 0.001) "***" else if (p < 0.01) "**" else if (p < 0.05) "*" else ""
}
# Extract interaction p-value for elapsed_years:Group
coef_summary <- summary(mod)$coefficients
interaction_term <- paste0(xvar, ":", groupvar, unique(data[[groupvar]])[2])
# The exact name to match can be tricky, check which name matches in coef_summary
inter_pval <- coef_summary[grep("elapsed_years:Group", rownames(coef_summary)), "Pr(>|t|)"]
pval_label <- paste0(paste0("Time", " x ", groupvar,", p = "), round(signif(inter_pval, 3),3), sig_stars(signif(inter_pval, 3)))
# Create the plot
p <- ggplot() +
geom_line(data = data,
aes_string(x = xvar, y = "predicted_indiv", group = "USUBJID", color = groupvar),
alpha = 0.3, size = 0.5) +
geom_line(data = pred_data,
aes(x = elapsed_years, y = predicted, color = Group),
size = 1.5) +
labs(title = "",
x = xvar,
y = response) +
theme_minimal() +
scale_color_manual(values = colors)+
annotate("text", x = Inf, y = -Inf, label = pval_label, hjust = 1.0, vjust = -1, size = 3.0, color = "black")
#print(summary(mod))
if(!show.legend){
p <- p + theme(legend.position = "none")
}
return(p)
}
plot_lmer_model_with_interaction_p <-function(data, response = "whr",
xvar = "elapsed_years", groupvar = "Change_Type",
covariates = c("AGE", "SEX", "EDUYR"),
colors = c("StableCN" = "#0072B2", "CNtransitMCI" = "#E69F00"),
n_points = 100, show.legend = FALSE) {
# Fit the model with lmerTest to get p-values
formula_str <- paste0(response, " ~ ", xvar, "*", groupvar, " + ",
paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
mod <- lmer(formula_str, data = data)
# Create prediction grid for fixed effects
pred_data <- expand.grid(
elapsed_years = seq(min(data[[xvar]], na.rm = TRUE),
max(data[[xvar]], na.rm = TRUE),
length.out = n_points),
Change_Type = unique(data[[groupvar]])
)
for (cov in covariates) {
if (is.numeric(data[[cov]])) {
pred_data[[cov]] <- median(data[[cov]], na.rm = TRUE)
} else if (is.factor(data[[cov]])) {
pred_data[[cov]] <- levels(data[[cov]])[1]
}
}
title <-  paste("Predicted", response, "Trajectories by Group")
# Predict fixed effects only i.e Smooth overall preidtcion for MCI or CN
pred_data$predicted <- predict(mod, newdata = pred_data, re.form = NA)
# Predict individual subject trajectories (include random effects)
data$predicted_indiv <- predict(mod, newdata = data, re.form = NULL)
sig_stars <- function(p) {
if (p < 0.001) "***" else if (p < 0.01) "**" else if (p < 0.05) "*" else ""
}
# Extract interaction p-value for elapsed_years:Group
coef_summary <- summary(mod)$coefficients
interaction_term <- paste0(xvar, ":", groupvar, unique(data[[groupvar]])[2])
# The exact name to match can be tricky, check which name matches in coef_summary
inter_pval <- coef_summary[grep("elapsed_years:Group", rownames(coef_summary)), "Pr(>|t|)"]
pval_label <- paste0(paste0("Time", " x ", groupvar,", p = "), round(signif(inter_pval, 3),3), sig_stars(signif(inter_pval, 3)))
# Create the plot
p <- ggplot() +
geom_line(data = data,
aes_string(x = xvar, y = "predicted_indiv", group = "USUBJID", color = groupvar),
alpha = 0.3, size = 0.5) +
geom_line(data = pred_data,
aes(x = elapsed_years, y = predicted, color = Group),
size = 1.5) +
labs(title = "",
x = xvar,
y = response) +
theme_minimal() +
scale_color_manual(values = colors)+
annotate("text", x = Inf, y = -Inf, label = pval_label, hjust = 1.0, vjust = -1, size = 3.0, color = "black")
#print(summary(mod))
if(!show.legend){
p <- p + theme(legend.position = "none")
}
return(p)
}
df_long.analysis <- df_long.analysis %>%filter(Change_Type %in% c("StableCN","CNtransitMCI"))
(plt1 <- plot_lmer_model_with_interaction_p(df_long.analysis, response = "MMSE"))
